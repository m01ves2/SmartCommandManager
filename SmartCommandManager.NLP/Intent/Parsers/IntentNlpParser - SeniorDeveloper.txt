using SmartCommandManager.Domain.Exceptions;
using SmartCommandManager.Domain.Commands;
using SmartCommandManager.Domain.NLP;

namespace SmartCommandManager.Application.NLP
{
    public sealed class IntentNlpParser : IIntentNlpParser
    {
        public NlpIntentResult Parse(IReadOnlyList<Token> tokens, IEnumerable<ICommand> commands)
        {
            var matches = CollectIntentMatches(tokens, commands).ToList();

            if (matches.Count == 0)
                throw new IntentNotFoundException("");

            if (matches.Count > 1)
                throw new AmbiguousIntentException("");

            var match = matches.Single();

            if (match.Indexes.Count > 1)
                throw new IntentRepeatedException("");

            return new NlpIntentResult(match.Command.IntentPattern.Primary, match.Indexes[0]);
        }

        private IEnumerable<IntentMatch> CollectIntentMatches(
            IReadOnlyList<Token> tokens,
            IEnumerable<ICommand> commands)
        {
            foreach (var command in commands) {
                var indexes = FindAllIndexes(tokens, command.IntentPattern.Aliases );

                if (indexes.Count > 0)
                    yield return new IntentMatch(command, indexes);
            }
        }

        private List<int> FindAllIndexes(IReadOnlyList<Token> tokens, IEnumerable<string> Aliases )
        {
            var results = new List<int>();

            for (int i = 0; i < tokens.Count; i++) {
                if (Aliases .Contains(tokens[i].Value))
                    results.Add(i);
            }

            return results;
        }

        private sealed record IntentMatch(ICommand Command, List<int> Indexes);
    }
}
